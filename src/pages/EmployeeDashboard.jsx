import { useEffect, useRef, useState } from "react";
import { useFeedbacks } from "../context/FeedbackContext.jsx";

export default function EmployeeDashboard() {
  const { feedbacks, updateFeedbackStatus } = useFeedbacks();

    // üí° √âtat pour le toast visuel
      const [toast, setToast] = useState(null);
        const previousCount = useRef(feedbacks.length);

          // üß† Surveille les nouveaux feedbacks ajout√©s
            useEffect(() => {
                if (feedbacks.length > previousCount.current) {
                      const newFb = feedbacks[feedbacks.length - 1];
                            setToast(`üîî Nouvel avis re√ßu pour ${newFb.ride}`);
                                  setTimeout(() => setToast(null), 4000);
                                      }
                                          previousCount.current = feedbacks.length;
                                            }, [feedbacks]);

                                              // üì¶ Action employ√©
                                                const handleAction = (id, newStatus) => {
                                                    updateFeedbackStatus(id, newStatus);
                                                        const msg =
                                                              newStatus === "validated"
                                                                      ? "‚úÖ Avis valid√© avec succ√®s."
                                                                              : newStatus === "rejected"
                                                                                      ? "‚ùå Avis rejet√©."
                                                                                              : "‚ö†Ô∏è Le chauffeur sera contact√©.";
                                                                                                  alert(msg);
                                                                                                    };

                                                                                                      return (
                                                                                                          <div className="relative max-w-5xl mx-auto mt-10 p-6 bg-gray-50 rounded-2xl shadow-sm">
                                                                                                                <h2 className="text-3xl font-bold mb-6 text-emerald-600 text-center">
                                                                                                                        Espace Employ√© üë©‚Äçüíº
                                                                                                                              </h2>

                                                                                                                                    {/* üîî Notification toast */}
                                                                                                                                          {toast && (
                                                                                                                                                  <div className="fixed top-5 right-5 bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg animate-fadeIn">
                                                                                                                                                            {toast}
                                                                                                                                                                    </div>
                                                                                                                                                                          )}

                                                                                                                                                                                {feedbacks.length === 0 ? (
                                                                                                                                                                                        <p className="text-center text-gray-500">
                                                                                                                                                                                                  Aucun avis ou signalement en attente.
                                                                                                                                                                                                          </p>
                                                                                                                                                                                                                ) : (
                                                                                                                                                                                                                        <div className="grid gap-6">
                                                                                                                                                                                                                                  {feedbacks.map((fb) => (
                                                                                                                                                                                                                                              <div
                                                                                                                                                                                                                                                            key={fb.id}
                                                                                                                                                                                                                                                                          className="bg-white border border-gray-200 rounded-xl p-5 shadow"
                                                                                                                                                                                                                                                                                      >
                                                                                                                                                                                                                                                                                                    <h3 className="font-semibold text-lg mb-1 text-gray-800">
                                                                                                                                                                                                                                                                                                                    üöó {fb.ride}
                                                                                                                                                                                                                                                                                                                                  </h3>
                                                                                                                                                                                                                                                                                                                                                <p className="text-sm text-gray-600 mb-2">
                                                                                                                                                                                                                                                                                                                                                                <strong>Passager :</strong> {fb.passenger} <br />
                                                                                                                                                                                                                                                                                                                                                                                <strong>Chauffeur :</strong> {fb.driver}
                                                                                                                                                                                                                                                                                                                                                                                              </p>
                                                                                                                                                                                                                                                                                                                                                                                                            <p className="italic text-gray-700 mb-3">
                                                                                                                                                                                                                                                                                                                                                                                                                            ¬´ {fb.comment} ¬ª ({fb.rating}‚≠ê)
                                                                                                                                                                                                                                                                                                                                                                                                                                          </p>

                                                                                                                                                                                                                                                                                                                                                                                                                                                        {fb.status === "pending" ? (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="flex flex-wrap gap-3">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onClick={() => handleAction(fb.id, "validated")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  className="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1 rounded-md"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ‚úÖ Valider
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                onClick={() => handleAction(fb.id, "rejected")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ‚ùå Rejeter
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  onClick={() => handleAction(fb.id, "contact")}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      className="bg-yellow-400 hover:bg-yellow-500 text-black px-3 py-1 rounded-md"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ‚ö†Ô∏è Contacter
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ) : (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <p className="mt-2 text-sm text-gray-500">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              Statut :{" "}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <span
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className={
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          fb.status === "validated"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ? "text-emerald-600"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          : fb.status === "rejected"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ? "text-red-500"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          : "text-yellow-500"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {fb.status === "validated"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          ? "Valid√©"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                : fb.status === "rejected"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ? "Rejet√©"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            : "En contact avec le chauffeur"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
